{
  "hash": "7ddf0fb06ddb5c8ca842fb659a7cd1ed",
  "result": {
    "markdown": "---\ntitle: \"geofacet\"\nformat: html\neditor: visual\n---\n\n\nYou can follow along with the `geofacet.qmd` file in the **nicar-2023-fancier-viz** project folder that you downloaded in the [**First steps**](data_prep.html) link.\n\nIf you've downloaded the appropriate data files and put them in a data folder, you can just copy and paste all the code in the gray boxes in an R script.\n\nWe're going to try a package called **geofacet**.\n\nType out or copy and paste all the code in all the gray sections below in your own script or console or run the chunks as they appear in the `geofacet.qmd` file.\n\nLet's load the libraries, import the state-level data and see the structure of the data we've imported.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(geofacet)\n\nstate_df <- read_csv(\"data/opioids_states.csv\")\n\nglimpse(state_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 918\nColumns: 12\n$ buyer_state <chr> \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\"…\n$ year        <dbl> 2006, 2006, 2007, 2007, 2008, 2008, 2009, 2009, 2010, 2010…\n$ pills       <dbl> 15667010, 15667010, 17272433, 17272433, 18707811, 18707811…\n$ state       <chr> \"Alaska\", \"Alaska\", \"Alaska\", \"Alaska\", \"Alaska\", \"Alaska\"…\n$ deaths      <dbl> 29, 29, 15, 15, 88, 88, 90, 90, 62, 62, 66, 66, 81, 81, 69…\n$ population  <dbl> 675302, 675302, 680300, 680300, 687455, 687455, 698895, 69…\n$ crude_rate  <chr> \"4.3\", \"4.3\", \"Unreliable\", \"Unreliable\", \"12.8\", \"12.8\", …\n$ type        <chr> \"death_per_1m\", \"pills_per_person\", \"death_per_1m\", \"pills…\n$ rate        <dbl> 42.9, 23.2, 22.0, 25.4, 128.0, 27.2, 128.8, 28.8, 87.3, 29…\n$ state_code  <chr> \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\", \"AK\"…\n$ region      <chr> \"West\", \"West\", \"West\", \"West\", \"West\", \"West\", \"West\", \"W…\n$ division    <chr> \"Pacific\", \"Pacific\", \"Pacific\", \"Pacific\", \"Pacific\", \"Pa…\n```\n:::\n:::\n\n\nGreat, let's start some exploratory visualizations. We've got annual data on rates of deaths and pill purchases in the columns `type` and `rate` for each state and year in the country.\n\nLet's plot it to our relevant state for this workshop: Tennessee.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Because the data is tidy, we can easily plot both rates in a single chart\n\nstate_df %>% \n  filter(state==\"Tennessee\") %>% \n  ggplot(aes(x=year, y=rate, color=type)) +\n  geom_line() +\n  theme_minimal() +\n  labs(title=\"Rates of opioid purchases and deaths in Tennessee\")\n```\n\n::: {.cell-output-display}\n![](geofacet_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nVery interesting!\n\nThat's just one state.\n\nLet's use all the great ggplot2 features like creating small multiples of the charts based on each state (Did you know Datawrapper supports [some](https://academy.datawrapper.de/article/162-alternatives-for-drop-down-menus-and-tabs) small multiples viz?).\n\nAll we need to add is the function `facet_wrap()` and pass it the variable we want to create small multiples with: *buyer_state*.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_df %>% \n# commenting out the line from above\n# filter(state==\"Tennessee\") %>% \n  ggplot(aes(x=year, y=rate, color=type)) +\n  geom_line() +\n# adding a new line here\n  facet_wrap(vars(buyer_state), ncol=8) +\n  theme_minimal() +\n  labs(title=\"Rates of opioid purchases and deaths in Tennessee\")\n```\n\n::: {.cell-output-display}\n![](geofacet_files/figure-html/unnamed-chunk-2-1.png){width=864}\n:::\n:::\n\n\nOkay, that's a start. We see some interesting variability...\n\nThere's a cluster around the states that start with M and O and W! But that's not relevant!\n\nThe problem is the states are all alphabetical. That's not a huge problem for categorical data most of the time but we're used to states in certain areas in relation to other states, right?\n\nThis is a great opportunity for the package [**geofacet**](https://hafen.github.io/geofacet/)which adds on to ggplot2 that makes it easy to create geographically faceted visualizations. No state is a silo. By mimicking the original geographic topology, you can see patterns much more clearly.\n\nIt's very simple.\n\nInstead of using `facet_wrap()` from **ggplot2**, you load the **geofacet** package and use the function `facet_geo()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# same lines as before\nstate_df %>% \n  ggplot(aes(x=year, y=rate, color=type)) +\n  geom_line() +\n# deleting the line below\n# facet_wrap(vars(buyer_state), ncol=8) +\n  facet_geo(vars(buyer_state)) +\n  theme_minimal() +\n  labs(title=\"Rates of opioid purchases and deaths by state\")\n```\n\n::: {.cell-output-display}\n![](geofacet_files/figure-html/unnamed-chunk-3-1.png){width=864}\n:::\n:::\n\n\nIsn't this better? What sort of regional patterns can you spot now?\n\nThe states surrounding West Virginia were definitely affected by opioid overdoses.\n\nIn the last few years of data, it appears like the Northeast was deeply affected.\n\nIf you don't like that shape, you can pass it an argument for what type of grid to use. Instead of the default, we'll pass it the argument \"us_state_grid2\" which I personally like more.\n\nAnd we'll clean up the labels in the x axis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_df %>% \n  ggplot(aes(x=year, y=rate, color=type)) +\n  geom_line() +\n# deleting the line below\n# facet_geo(vars(buyer_state)) +\n  facet_geo(vars(buyer_state), grid = \"us_state_grid2\") +\n  theme_minimal() +\n# adding in a new line\n  scale_x_continuous(breaks=c(2006, 2014),\n                     labels=c(\"'06\", \"'14\")) +\n  labs(title=\"Rates of opioid purchases and deaths in the U.S.\")\n```\n\n::: {.cell-output-display}\n![](geofacet_files/figure-html/unnamed-chunk-4-1.png){width=864}\n:::\n:::\n\n\nThe geofacets aren't limited to states.\n\nThere are 140+ grids available so far, from European countries, to regions in New Zealand, to provinces of Afghanistan. Check out the [complete list](https://hafen.github.io/geofacet/) for now-- if you don't see one that you're looking for, it's very simple to [create your own](https://hafen.github.io/grid-designer/) and submit a pull request.\n\nFor now, let's pull in some county level data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_df <- read_csv(\"data/opioids_counties.csv\")\n\nglimpse(county_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 55,516\nColumns: 13\n$ buyer_county <chr> \"ABBEVILLE\", \"ABBEVILLE\", \"ABBEVILLE\", \"ABBEVILLE\", \"ABBE…\n$ buyer_state  <chr> \"SC\", \"SC\", \"SC\", \"SC\", \"SC\", \"SC\", \"SC\", \"SC\", \"SC\", \"SC…\n$ year         <dbl> 2006, 2006, 2007, 2007, 2008, 2008, 2009, 2009, 2010, 201…\n$ count        <dbl> 877, 877, 908, 908, 871, 871, 930, 930, 1197, 1197, 1327,…\n$ dosage_unit  <dbl> 363620, 363620, 402940, 402940, 424590, 424590, 467230, 4…\n$ countyfips   <chr> \"45001\", \"45001\", \"45001\", \"45001\", \"45001\", \"45001\", \"45…\n$ state        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ county       <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ deaths       <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ crude_rate   <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…\n$ population   <dbl> 25821, 25821, 25745, 25745, 25699, 25699, 25347, 25347, 2…\n$ type         <chr> \"death_per_100k\", \"pills_per_person\", \"death_per_100k\", \"…\n$ rate         <dbl> NA, 14.1, NA, 15.7, NA, 16.5, NA, 18.4, NA, 21.0, NA, 22.…\n```\n:::\n:::\n\n\nLet's narrow down the county data to only Tennessee.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntennessee <- county_df %>% \n  filter(buyer_state==\"TN\")\n\nglimpse(tennessee)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 1,702\nColumns: 13\n$ buyer_county <chr> \"ANDERSON\", \"ANDERSON\", \"ANDERSON\", \"ANDERSON\", \"ANDERSON…\n$ buyer_state  <chr> \"TN\", \"TN\", \"TN\", \"TN\", \"TN\", \"TN\", \"TN\", \"TN\", \"TN\", \"TN…\n$ year         <dbl> 2006, 2006, 2007, 2007, 2008, 2008, 2009, 2009, 2010, 201…\n$ count        <dbl> 11948, 11948, 12708, 12708, 14350, 14350, 15784, 15784, 1…\n$ dosage_unit  <dbl> 5065930, 5065930, 5354720, 5354720, 5800560, 5800560, 627…\n$ countyfips   <chr> \"47001\", \"47001\", \"47001\", \"47001\", \"47001\", \"47001\", \"47…\n$ state        <chr> \"Tennessee\", \"Tennessee\", NA, NA, \"Tennessee\", \"Tennessee…\n$ county       <chr> \"Anderson County, TN\", \"Anderson County, TN\", NA, NA, \"An…\n$ deaths       <dbl> 10, 10, NA, NA, 11, 11, NA, NA, 11, 11, 14, 14, 11, 11, 2…\n$ crude_rate   <chr> \"Unreliable\", \"Unreliable\", NA, NA, \"Unreliable\", \"Unreli…\n$ population   <dbl> 73117, 73117, 73580, 73580, 74397, 74397, 73382, 73382, 7…\n$ type         <chr> \"death_per_100k\", \"pills_per_person\", \"death_per_100k\", \"…\n$ rate         <dbl> 13.7, 69.3, NA, 72.8, 14.8, 78.0, NA, 85.5, 14.8, 84.8, 1…\n```\n:::\n:::\n\n\nLet's make a small multiple chart using the county-level data for Tennessee.\n\nWe'll have to pass it the grid argument of \"us_tn_counties_grid1\".\n\nAlso, you may want to copy and paste the chunk of code to run in console so the map shows up in the viewer instead of the notebook. Then you can expand it out and see the names better.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntennessee %>% \n  mutate(buyer_county=str_to_title(buyer_county)) %>% \n  ggplot(aes(x=year, y=rate, color=type)) +\n  geom_line() +\n  facet_geo(vars(buyer_county), grid = \"us_tn_counties_grid1\") +\n  theme_minimal() +\n  scale_x_continuous(breaks=c(2006, 2014),\n                     labels=c(\"'06\", \"'14\")) +\n  labs(title=\"Rates of opioid purchases and deaths in Tennessee\")\n```\n\n::: {.cell-output-display}\n![](geofacet_files/figure-html/unnamed-chunk-7-1.png){width=864}\n:::\n:::\n\n\nFascinating! It's a little crammed together to fit on this specific page.\n\nIf you ran it in your console you may have a pop up where the names all fit.\n\nThere's a lot of data missing because there weren't enough annual deaths for CDC to release the data. You may need to widen the scope of the CDC query or go to the state health department for the missing data.\n\nLet's try another way to visualize the relationship between deaths and purchases.\n\nWhen you're done with this section, move on to [**ggrepel**](ggrepel.html).\n\n## Quick aside\n\nI wanted to highlight a geofacet project that made it to publication: **The staggering scope of U.S. gun deaths goes far beyond mass shootings** \\[[**link**](https://www.washingtonpost.com/nation/interactive/2022/gun-deaths-per-year-usa/)\\]\n\n1.  Simple geofacet dataviz of how restrictive gun laws are by state.\n\n![](images/sm1.png){fig-align=\"center\"}\n\n2.  Overlaying rates of firearm deaths with estimated fire arm purchases with the restrictive gun law categorized overlaid.\n\n![](images/sm2.png){fig-align=\"center\"}\n\n3.  Highlighting for context areas of interest and why\n\n![](images/sm3.png){fig-align=\"center\"}\n\n4.  One more viz with small multiples of geofacets and grouped slope graphs based on strength of gun control laws.\n\n![](images/sm4.png){fig-align=\"center\"}\n\nProps to [Artur Galocha](https://twitter.com/arturgalocha) for putting this beautiful viz together based off from some very basic exploratory data viz.\n",
    "supporting": [
      "geofacet_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}