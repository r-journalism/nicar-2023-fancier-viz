{
  "hash": "5bf4f0ca5ac7bf7fadca2e2548151de0",
  "result": {
    "markdown": "---\ntitle: \"Visualizing relationships five different ways\"\nformat: html\neditor: visual\n---\n\n\n## One data set, Five visualizations (technically two data sets)\n\nBefore you do anything at all...\n\n# Update your software\n\nMake sure you have the latest versions of R and RStudio installed.\n\nA lot of these new tools we're using depend on the latest builds of R and RStudio to work correctly.\n\n* [Latest version of R](https://cran.r-project.org/)\n* [Latest version of RStudio](https://posit.co/download/rstudio-desktop/)\n\nNo, seriously, do it.\n\n# Install packages \n\nCopy and paste the following lines of code into your RStudio console.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Checking if the packages you need are installed -- if not, it will install for you\npackages <- c(\"tidyverse\", \"usethis\", \"devtools\", \n              \"remotes\", \"lubridate\", \"knitr\", \n              \"janitor\", \"geofacet\", \"ggrepel\", \n              \"png\", \"gifski\", \"sf\", \"tigris\", \n              \"cowplot\", \"biscale\", \"ggtext\")\n\nif (length(setdiff(packages, rownames(installed.packages()))) > 0) {\n  install.packages(setdiff(packages, rownames(installed.packages())), \n                   repos = \"https://cran.us.r-project.org\")  \n}\n\ndevtools::install_github('wpinvestigative/arcos')\n\nusethis::use_course(\"https://github.com/r-journalism/nicar-2023-fancier-viz/archive/master.zip\")\n```\n:::\n\n\nThe last line of code you ran will walk you through installing the class materials to your desktop. Select yes at the right points.\n\nWhen you're done downloading the files, you can move on to [**geofacet**](geofacet.html). \n\nLater on you can follow these steps on how to download and transform the data used in these walkthroughs below.\n\n# Data for the walkthroughs\n\nThe opioid transaction data from the DEA and opioid deaths data from the CDC needed for these walkthroughs have already been downloaded and transformed. The steps below exist for transparency.\n\n# Preparing state data\n\n## Get annual opioid sales data from ARCOS api\n\nThe Washington Post [published](https://www.washingtonpost.com/national/2019/07/18/how-download-use-dea-pain-pills-database/) a significant portion of a [database](https://www.washingtonpost.com/graphics/2019/investigations/dea-pain-pill-database/) that tracks the path of every opioid pain pill, from manufacturer to pharmacy, in the United States between 2006 and 2014. The data below is pulled from an [API](https://wpinvestigative.github.io/arcos/) that the Post created to make it easier to query the data.\n\nWe'll pull opioid sales data by year.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(knitr)\nlibrary(janitor)\n\ndevtools::install_github('wpinvestigative/arcos')\nlibrary(arcos)\n\nstates <- combined_buyer_annual(key=\"WaPo\") %>% \n  clean_names()\n\nstates %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|buyer_dea_no |buyer_bus_act   |buyer_county |buyer_state | year| dosage_unit|\n|:------------|:---------------|:------------|:-----------|----:|-----------:|\n|A90777889    |RETAIL PHARMACY |KINGS        |NY          | 2006|      110700|\n|A90777889    |RETAIL PHARMACY |KINGS        |NY          | 2007|      119100|\n|A90777889    |RETAIL PHARMACY |KINGS        |NY          | 2008|      100300|\n|A90777889    |RETAIL PHARMACY |KINGS        |NY          | 2009|       92630|\n|A90777889    |RETAIL PHARMACY |KINGS        |NY          | 2010|       65860|\n|A90777889    |RETAIL PHARMACY |KINGS        |NY          | 2011|       72030|\n:::\n:::\n\n\n## Transform the data\n\nNext, we'll summarize the data by state and year.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_names <- c(state.name, \"District of Columbia\")\nstate_abbr <- c(state.abb, \"DC\")\n\nstate_names <- data.frame(state=state_names, buyer_state=state_abbr)\n\nannual_states <- states %>% \n  group_by(buyer_state, year) %>% \n  summarize(pills=sum(dosage_unit)) %>% \n  left_join(state_names) %>% \n  filter(!is.na(state))\n\nannual_states %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|buyer_state | year|    pills|state  |\n|:-----------|----:|--------:|:------|\n|AK          | 2006| 15667010|Alaska |\n|AK          | 2007| 17272433|Alaska |\n|AK          | 2008| 18707811|Alaska |\n|AK          | 2009| 20160949|Alaska |\n|AK          | 2010| 21012703|Alaska |\n|AK          | 2011| 22444775|Alaska |\n:::\n:::\n\n\n## Get annual opioid overdose data from the CDC\n\nNCHS data is compiled in the CDC WONDER [online tool](https://wonder.cdc.gov). To retrieve these data from the tool: \n\n• Select the [Multiple Cause of Death](https://wonder.cdc.gov/mcd.html) (Detailed Mortality) query system; \n• Select table layout (for example, by year, state, county); and \n• Supply the appropriate underlying codes (X and Y code) and contributing codes (T codes) \n\n  * X40 - X44 \n  * X60 - X64 \n  * X85 \n  * Y10 - Y14 \n  * T40.0 - T40.4, T40.6\n\nThe data imported below was exported from the CDC Wonder data portal.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_cdc <- read_tsv(\"data/od_deaths_state.csv\") %>% \n  filter(is.na(Notes)) %>% \n  clean_names()\n\nstate_cdc %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|notes |state   |state_code | year| year_code| deaths| population|crude_rate |\n|:-----|:-------|:----------|----:|---------:|------:|----------:|:----------|\n|NA    |Alabama |01         | 2006|      2006|    124|    4628981|2.7        |\n|NA    |Alabama |01         | 2007|      2007|    165|    4672840|3.5        |\n|NA    |Alabama |01         | 2008|      2008|    185|    4718206|3.9        |\n|NA    |Alabama |01         | 2009|      2009|    206|    4757938|4.3        |\n|NA    |Alabama |01         | 2010|      2010|    187|    4779736|3.9        |\n|NA    |Alabama |01         | 2011|      2011|    176|    4802740|3.7        |\n:::\n:::\n\n\n## Join the state data\n\nBringing together the sales data with the deaths data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_joined <- annual_states %>% \n  left_join(state_cdc) %>% \n  select(-notes, -state_code, -year_code)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(year, state)`\n```\n:::\n\n```{.r .cell-code}\nstate_joined %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|buyer_state | year|    pills|state  | deaths| population|crude_rate |\n|:-----------|----:|--------:|:------|------:|----------:|:----------|\n|AK          | 2006| 15667010|Alaska |     29|     675302|4.3        |\n|AK          | 2007| 17272433|Alaska |     15|     680300|Unreliable |\n|AK          | 2008| 18707811|Alaska |     88|     687455|12.8       |\n|AK          | 2009| 20160949|Alaska |     90|     698895|12.9       |\n|AK          | 2010| 21012703|Alaska |     62|     710231|8.7        |\n|AK          | 2011| 22444775|Alaska |     66|     722718|9.1        |\n:::\n:::\n\n\n## Wrangle the data\n\nLet's calculate rates.\n\nAdditionally, let's add in state categories and divisions.\n\nThen, we'll save it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstate_joined <- state_joined %>% \n  mutate(pills_per_person=round(pills/population,1)) %>% \n  mutate(death_per_1m=round(deaths/population*1000000,1)) %>% \n # rename(death_rate=crude_rate) %>% \n  pivot_longer(cols=c(\"death_per_1m\", \"pills_per_person\"),\n               names_to=\"type\",\n               values_to=\"rate\")\n\nregions <- read_csv(\"https://github.com/cphalpert/census-regions/raw/master/us%20census%20bureau%20regions%20and%20divisions.csv\") %>% \n  clean_names()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nRows: 51 Columns: 4\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (4): State, State Code, Region, Division\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n:::\n\n```{.r .cell-code}\nstate_joined <- left_join(state_joined, regions)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(state)`\n```\n:::\n\n```{.r .cell-code}\nwrite_csv(state_joined, \"data/opioids_states.csv\", na=\"\")\n```\n:::\n\n\n# County data annual\n\nLet's do the same thing but with county levle data.\n\n## Get annual opioid sales data from ARCOS api\n\nOnce again, we'll pull from the Post ARCOS api.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npharm_c <- summarized_county_annual(key=\"WaPo\") %>% \n  clean_names()\n\npharm_c %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|buyer_county |buyer_state | year| count| dosage_unit|countyfips |\n|:------------|:-----------|----:|-----:|-----------:|:----------|\n|ABBEVILLE    |SC          | 2006|   877|      363620|45001      |\n|ABBEVILLE    |SC          | 2007|   908|      402940|45001      |\n|ABBEVILLE    |SC          | 2008|   871|      424590|45001      |\n|ABBEVILLE    |SC          | 2009|   930|      467230|45001      |\n|ABBEVILLE    |SC          | 2010|  1197|      539280|45001      |\n|ABBEVILLE    |SC          | 2011|  1327|      566560|45001      |\n:::\n:::\n\n\n## Transform the data\n\n## Get annual opioid overdose data from the CDC\n\nFollowed the same steps as we did for state data but for counties.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_cdc <- read_tsv(\"data/od_deaths_county.csv\") %>% \n  filter(is.na(Notes)) %>% \n  clean_names() %>% \n  rename(countyfips=county_code)\n\ncounty_cdc %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|notes |state   |state_code |county             |countyfips | year| year_code| deaths| population|crude_rate |age_adjusted_rate |\n|:-----|:-------|:----------|:------------------|:----------|----:|---------:|------:|----------:|:----------|:-----------------|\n|NA    |Alabama |01         |Baldwin County, AL |01003      | 2006|      2006|     12|     168121|Unreliable |Unreliable        |\n|NA    |Alabama |01         |Baldwin County, AL |01003      | 2007|      2007|     14|     172404|Unreliable |Unreliable        |\n|NA    |Alabama |01         |Baldwin County, AL |01003      | 2008|      2008|     14|     175827|Unreliable |Unreliable        |\n|NA    |Alabama |01         |Baldwin County, AL |01003      | 2009|      2009|     10|     179406|Unreliable |Unreliable        |\n|NA    |Alabama |01         |Baldwin County, AL |01003      | 2010|      2010|     10|     182265|Unreliable |Unreliable        |\n|NA    |Alabama |01         |Baldwin County, AL |01003      | 2011|      2011|     11|     186717|Unreliable |Unreliable        |\n:::\n:::\n\n\n## Join the county data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_joined <- pharm_c %>% \n  full_join(county_cdc) %>% \n  select(-notes, -state_code, -year_code, -age_adjusted_rate)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(year, countyfips)`\n```\n:::\n\n```{.r .cell-code}\ncounty_joined %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|buyer_county |buyer_state | year| count| dosage_unit|countyfips |state |county | deaths| population|crude_rate |\n|:------------|:-----------|----:|-----:|-----------:|:----------|:-----|:------|------:|----------:|:----------|\n|ABBEVILLE    |SC          | 2006|   877|      363620|45001      |NA    |NA     |     NA|         NA|NA         |\n|ABBEVILLE    |SC          | 2007|   908|      402940|45001      |NA    |NA     |     NA|         NA|NA         |\n|ABBEVILLE    |SC          | 2008|   871|      424590|45001      |NA    |NA     |     NA|         NA|NA         |\n|ABBEVILLE    |SC          | 2009|   930|      467230|45001      |NA    |NA     |     NA|         NA|NA         |\n|ABBEVILLE    |SC          | 2010|  1197|      539280|45001      |NA    |NA     |     NA|         NA|NA         |\n|ABBEVILLE    |SC          | 2011|  1327|      566560|45001      |NA    |NA     |     NA|         NA|NA         |\n:::\n:::\n\n\n## Wrangle the data\n\nCalculating rates and saving the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# first have to bring in accurate population counts for counties annually\ncounty_pops <- county_population(key = \"WaPo\") %>% \n  select(countyfips, year, population)\n\ncounty_joined <- county_joined %>% \n  select(-population) %>% \n  left_join(county_pops) %>% \n  mutate(pills_per_person=round(dosage_unit/population,1)) %>% \n  mutate(death_per_100k=round(deaths/population*100000,1)) %>% \n # rename(death_rate=crude_rate) %>% \n  pivot_longer(cols=c(\"death_per_100k\", \"pills_per_person\"),\n               names_to=\"type\",\n               values_to=\"rate\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(year, countyfips)`\n```\n:::\n\n```{.r .cell-code}\nwrite_csv(county_joined, \"data/opioids_counties.csv\", na=\"\")\n```\n:::\n\n\n# County data combined\n\nLet's do it one more time but for all deaths between 2006 and 2014 combined.\n\n## Get annual opioid sales data from ARCOS api\n\nThis time we'll summarize it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npharm_c <- summarized_county_annual(key=\"WaPo\") %>% \n  clean_names()\n\npharm_c_combined <- pharm_c %>% \n  group_by(buyer_county, buyer_state, countyfips) %>% \n  summarize(count=sum(count, na.rm=T),\n            dosage_unit=sum(dosage_unit, na.rm=T))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'buyer_county', 'buyer_state'. You can\noverride using the `.groups` argument.\n```\n:::\n\n```{.r .cell-code}\npharm_c_combined %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|buyer_county |buyer_state |countyfips |  count| dosage_unit|\n|:------------|:-----------|:----------|------:|-----------:|\n|ABBEVILLE    |SC          |45001      |  10749|     4591000|\n|ACADIA       |LA          |22001      |  55952|    22197708|\n|ACCOMACK     |VA          |51001      |  19536|     6660470|\n|ADA          |ID          |16001      | 290484|   136806828|\n|ADAIR        |IA          |19001      |   5752|     1783165|\n|ADAIR        |KY          |21001      |  21985|     8783100|\n:::\n:::\n\n\n## Get annual opioid overdose data from the CDC\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_cdc <- read_tsv(\"data/od_deaths_counties_combined.csv\") %>% \n  filter(is.na(Notes)) %>% \n  clean_names() %>% \n  rename(countyfips=county_code)\n\ncounty_cdc %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|notes |state   |state_code |county             |countyfips | deaths| population|crude_rate |\n|:-----|:-------|:----------|:------------------|:----------|------:|----------:|:----------|\n|NA    |Alabama |01         |Baldwin County, AL |01003      |    105|    1651181|6.4        |\n|NA    |Alabama |01         |Bibb County, AL    |01007      |     11|     203479|Unreliable |\n|NA    |Alabama |01         |Blount County, AL  |01009      |     48|     514537|9.3        |\n|NA    |Alabama |01         |Calhoun County, AL |01015      |     10|    1053553|Unreliable |\n|NA    |Alabama |01         |Chilton County, AL |01021      |     10|     391161|Unreliable |\n|NA    |Alabama |01         |Cullman County, AL |01043      |     13|     722726|Unreliable |\n:::\n:::\n\n\n## Join the county data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_joined <- pharm_c_combined %>% \n  full_join(county_cdc) %>% \n  select(-notes, -state_code, -crude_rate)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(countyfips)`\n```\n:::\n\n```{.r .cell-code}\ncounty_joined %>% \n  head() %>% \n  kable()\n```\n\n::: {.cell-output-display}\n|buyer_county |buyer_state |countyfips |  count| dosage_unit|state     |county              | deaths| population|\n|:------------|:-----------|:----------|------:|-----------:|:---------|:-------------------|------:|----------:|\n|ABBEVILLE    |SC          |45001      |  10749|     4591000|NA        |NA                  |     NA|         NA|\n|ACADIA       |LA          |22001      |  55952|    22197708|Louisiana |Acadia Parish, LA   |     39|     554207|\n|ACCOMACK     |VA          |51001      |  19536|     6660470|Virginia  |Accomack County, VA |     22|     303140|\n|ADA          |ID          |16001      | 290484|   136806828|Idaho     |Ada County, ID      |    269|    3555029|\n|ADAIR        |IA          |19001      |   5752|     1783165|NA        |NA                  |     NA|         NA|\n|ADAIR        |KY          |21001      |  21985|     8783100|Kentucky  |Adair County, KY    |     14|     168051|\n:::\n:::\n\n\n## Wrangle the data\n\nCalculating rates.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_pops <- county_pops %>% \n  filter(year==2014) %>% \n  select(countyfips, year, population)\n\ncounty_joined <- county_joined %>% \n  select(-population) %>% \n  left_join(county_pops) %>% \n  mutate(pills_per_person=round(dosage_unit/population,1)) %>% \n  mutate(death_per_100k=round(deaths/population*100000,1)) %>% \n # rename(death_rate=crude_rate) %>% \n  pivot_longer(cols=c(\"death_per_100k\", \"pills_per_person\"),\n               names_to=\"type\",\n               values_to=\"rate\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(countyfips)`\n```\n:::\n\n```{.r .cell-code}\nwrite_csv(county_joined, \"data/opioids_counties_combined.csv\", na=\"\")\n```\n:::\n\n\nNext, we'll move on to first steps in visualizing these data sets.\n\n",
    "supporting": [
      "data_prep_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}