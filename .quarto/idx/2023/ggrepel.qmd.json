{"title":"ggrepel","markdown":{"yaml":{"title":"ggrepel","format":"html","editor":"visual"},"headingText":"| warning: FALSE","containsRefs":false,"markdown":"\n\nYou can follow along with the `ggrepel.qmd` file in the **nicar-2023-fancier-viz** project folder that you downloaded in the [**First steps**](data_prep.html)link.\n\nIf you've downloaded the appropriate data files and put them in a data folder, you can just copy and paste all the code in the gray boxes in an R script.\n\nThis time, we're going to use a package called **ggrepel**.\n\nLet's load the libraries, import the state-level data and see the structure of the data we've imported.\n\n```{r loading}\n#| message: FALSE\n\nlibrary(tidyverse)\nlibrary(ggrepel)\n\nstate_df <- read_csv(\"data/opioids_states.csv\")\n\nglimpse(state_df)\n```\n\nBefore we proceed, let's slice out the 2006 data only.\n\n```{r}\nstate_df_06 <-state_df %>% \n  filter(year==2006) %>% \n  pivot_wider(names_from=\"type\", values_from=\"rate\")\n\nglimpse(state_df_06)\n```\n\nOkay, we went from 918 rows of data to 51.\n\nLet's see if there's a relationship between rates of opioid purchases and opioid deaths in 2006.\n\nWe'll plot it out with `geom_point()` from the ggplot2 package.\n\n```{r}\n#| warning: FALSE\n#| message: FALSE\n\n\nggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +\n  geom_point() +\n  geom_smooth(method='lm') +\n  theme_minimal()\n```\n\nAlright, so it definitely looks like there's something interesting here.\n\nBut it'd be nice to be able to see right away which dots represent which states.\n\nThe default method of showing text in ggplot2 is the function `geom_text()`.\n\nLet's try it below.\n\n```{r}\n#| warning: FALSE\n#| message: FALSE\n\nggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +\n  geom_point() +\n  geom_smooth(method='lm') +\n  geom_text(aes(label=buyer_state), size=3) +\n  theme_minimal()\n```\n\nYuck, it pops up right where the dots appear. We need to move it over.\n\nYou can pass it the argument `hjust` and change the number till it's just right.\n\nTry it with .5 pixels.\n\n```{r}\n#| warning: FALSE\n#| message: FALSE\n\nggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +\n  geom_point() +\n  geom_smooth(method='lm') +\n# Changing this line \n# geom_text(aes(label=buyer_state), size=3) +\n  geom_text(aes(label=buyer_state), hjust=-.5, size=3) +\n  theme_minimal()\n```\n\nHrm, still not great. Look at the two dots under \"UT\" -- \"RNM\"? What is that?\n\nLet's use the package **ggrepel** that members of the data community made that automatically moves text labels for you based on proximity of other labels.\n\nInstead of the function `geom_text()`, use the function `geom_text_repel().`\n\n```{r}\n#| warning: FALSE\n#| message: FALSE\n\nggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +\n  geom_point() +\n  geom_smooth(method='lm') +\n# Changing this line \n# geom_text(aes(label=buyer_state), hjust=-.5, size=3) +\n  geom_text_repel(aes(label=buyer_state), size=3) +\n  theme_minimal()\n```\n\nBeautiful! and so easy!\n\nNow, you can save it as a pdf or svg and tinker with it even more in Illustrator before publishing.\n\nLet me show you a way to show only the labels for outliers. Let's say those with more than 120 deaths per million. It requires some nested data wrangling.\n\n```{r}\n#| warning: FALSE\n#| message: FALSE\n\nggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +\n  geom_point() +\n  geom_smooth(method='lm') +\n# Changing this line\n# geom_text_repel(aes(label=buyer_state), size=3) +\n  geom_text_repel(data= . %>% \n                  mutate(new_label=ifelse(death_per_1m>120,\n                                        buyer_state, \"\")),\n                  aes(label=new_label), size=3) +\n  theme_minimal()\n```\n\nA little complicated, but you just have to see it in action and you can repurpose it for what you need.\n\nLet's go back and put in all the years and see what the pattern is once we display the data in small multiples.\n\n```{r}\n#| warning: FALSE\n#| message: FALSE\n#| fig.width: 9\n#| fig.height: 20\n#| \nstate_df_wide <-state_df %>% \n  #filter(year==2006) %>% \n  pivot_wider(names_from=\"type\", values_from=\"rate\")\n\nggplot(state_df_wide, aes(x=death_per_1m, y=pills_per_person)) +\n  geom_point() +\n  geom_text_repel(data= . %>% \n                  mutate(new_label=ifelse(death_per_1m>120,\n                                        buyer_state, \"\")),\n                  aes(label=new_label), size=3) +\n# new line below\n  facet_wrap(~year, ncol=2) +\n  theme_minimal()\n```\n\nIt's very illuminating to compare 2006 to 2014.\n\nThat could make for an interesting GIF, right?\n\nLet's move on to [**gganimate**](gganimate.html).\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"ggrepel.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.251","theme":"cosmo","title":"ggrepel","editor":"visual"},"extensions":{"book":{"multiFile":true}}}}}