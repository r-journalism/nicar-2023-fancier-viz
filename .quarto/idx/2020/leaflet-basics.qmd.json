{"title":"leaflet basics","markdown":{"yaml":{"title":"leaflet basics","format":"html","editor":"visual"},"headingText":"This section is in scripts/02_leaflet_locator_map.R","containsRefs":false,"markdown":"\n\n\nLet's create a locator map like you would when searching for an address on Google Maps.\n\n----\n\nThe repo containing the data and scripts for this section is on Github. \nTo follow along, simply run the lines of code below in R.\n\n```{r eval=F}\ninstall.packages(\"usethis\")\nusethis::use_course(\"https://github.com/andrewbtran/NICAR-2020-mapping/archive/master.zip\")\n\nfile.edit(\"scripts/02_leaflet_locator_map.R\")\n\n```\n\n----\n\nSometimes it's necessary to zoom in or pan around a map for greater comprehension while exploring data spatially.\n\nThe Leaflet R package was created by the folks behind RStudio to integrate with the popular opensource JavaScript library. \n\nIt’s great for journalists who have little knowledge of JavaScript who want to make interesting interactives using R. And there is [excellent documentation](https://rstudio.github.io/leaflet/) if you want to dig deeper into its functionality after this introduction.\n\nEssentially, this package lets you make maps with custom map tiles, markers, polygons, lines, popups, and geojson. Almost any maps you can make in Google Fusion Tables or Carto(DB), you can make in R using the Leaflet package.\n\n\n```{r loading_packages, warning=F, message=F}\n# This function checks if you don't have the correct packages installed yet\n# If not, it will install it for you\npackages <- c(\"dplyr\", \"httpuv\", \"readr\", \"leaflet\", \"sf\")\nif (length(setdiff(packages, rownames(installed.packages()))) > 0) {\n  install.packages(setdiff(packages, rownames(installed.packages())), repos = \"https://cran.us.r-project.org\")  \n}\n\nlibrary(leaflet)\nlibrary(dplyr)\n```\n\n\n\n## Putting a marker on a map\n\nLet's begin by finding a latitude and longitude to map.\n\nGo to [Google Maps](https://www.google.com/maps/) and search for any address.\n\nRight click on the map until you get this menu.\n\n![](images/right_map.png)\n\nSelect \"What's here?\" and at the bottom copy and paste that latitude and longitude.\n\n![](images/lat_lon.png)\n\n\n1. Create a map widget by calling the `leaflet()` function\n2. Add *layers* (such as features) to the map by using layer functions\n    * like `addTiles`, `addMarkers`, `addPolygons`\n3. Print the map widget\n4. Customize the view port zoom and center location with `setView()`\n\n```{r first_map_simplified,  fig.width=8, fig.height=4, warning=F, message=F}\n# Insert your latitude and longitude in the code below\n# NOTE: Don't get them reversed otherwise you'll end up in the South Pole.\n\n# Initialize and assign m as the leaflet object\nm <- leaflet() %>%\n# Now add tiles to it\n    addTiles() %>%  \n# Setting the middle of where the map should be and the zoom level\n    setView(lng=-77.030137, lat=38.902986, zoom = 16) %>%\n# Now, add a marker with a popup, \n    addMarkers(lng=-77.030137, lat=38.902986, popup=\"<b>Hello</b><br><a href='https://www.washingtonpost.com'>-Me</a>\")\n\nm \n```\n\nGo ahead and click the blue marker.\n\n**Explaining the R code**\n\n* `leaflet()` initializes the leaflet work space\n* `addTiles()` by itself will bring in the default OpenStreetMap tiles\n    * Here's [a list](https://leaflet-extras.github.io/leaflet-providers/preview/) of free leaflet tiles you can use\n    * **Note:** OpenStreetMaps is a wonderful and free open-source service. Their only stipulation for using their tiles is to be sure to credit and link to them in the map.\n* `setView()` is pretty self-explanatory but is simpler to implement\n* `addMarkers()` with some specific parameters.\n\n**Note:** The order of commands is important. A view can’t be set unless there are tiles established first.\n\n**Another note:** We're using pipes (%>%) in our code, which is part of dplyr/magrittr. It's a form of R syntax that has sort of revolutionized legible coding. Here's a quick breakdown:\n\n![](https://4va.github.io/biodatasci/img/nest_vs_pipe.jpg)\n\nTo learn more about pipes, visit any number [of tutorials](https://seananderson.ca/2014/09/13/dplyr-intro/).\n\n## Multiple locations from a csv\n\nLet's bring in some new data based on pharmacies. This is opioid pain pill data for Louisiana between 2006 and 2012 via the [arcos](https://wpinvestigative.github.io/arcos/) api (shameless self-promotion here since I made this api with R and the [plumber](https://www.rplumber.io/) and [pkgdown](https://pkgdown.r-lib.org/) packages).\n\n```{r import1, warning=F, message=F}\nlibrary(readr)\n\npharmacies <- read_csv(\"data/all_pharmacies_summarized.csv\")\n\nglimpse(pharmacies)\n```\n\nWe've imported more than 82,000 rows of data on pharmacies across the U.S. and how many opioids they ordered between 2006 and 2012. If you'd like to see the script that generated this data, check out the `state_pharm_data.R` script.\n\nLet's limit it to a single state because tens of thousands of dots on a slippy map is taxing on a browser. Maybe we'll get more ambitious later.\n\n```{r filtered_dd}\n# Pick a state, any state.\n# I'll use Louisiana here because that's where NICAR is this year\n\npharm_state <- pharmacies %>% \n  filter(BUYER_STATE==\"LA\")\n```\n\nLet's make a map with a new tile set. Instead of leaving `addTiles()` empty, which uses the OpenStreetMap default, we'll pass on some new data to some other third-party tiles with the `addProviderTiles()` function. Check out all the neat [tile options](https://leaflet-extras.github.io/leaflet-providers/preview/index.html).\n\nSome options to use with `addCircles` includes the data to pull in for `popup` and `color`, which we've made bright orange. We've also set `radius` and `weight` and `fillOpacity`.\n\nIf we wanted to change the radius of the circle based on some data point, you could replace `40` with some column with numeric values in it.\n\nAnd of course we have to change the latitude and longitude values in `setView()` so they focus on the state we filtered.\n\n```{r dunk_map_1, fig.width=9, fig.height=4, warning=F, message=F}\nm <- leaflet(pharm_state) %>% addProviderTiles(providers$CartoDB.DarkMatter) %>% \n  setView(-92.469698, 31.012156, zoom = 7) %>% \n  addCircles(~lon, ~lat, popup=pharm_state$BUYER_NAME, weight = 3, radius=40, \n                 color=\"#ffa500\", stroke = TRUE, fillOpacity = 0.8) \nm\n```\n\nThat's a start but we can do better.\n\nWe can reflect the average number of pills per person per year by the size of the circles.\n\nTo do that, we must switch from `addCircles` to `addCircleMarkers`.\n\nChange that in the radius variable below.\n\nAnd we'll adjust the pop up language with some basic html.\n\n```{r dunk_map1, fig.width=9, fig.height=4, warning=F, message=F}\n\n# we also have to rearrange the order of the dataframe\n# so the smaller values will render over the larger ones\n# this means big circles won't block the small circles\n\npharm_state <- pharm_state %>% \n  arrange(desc(per_person))\n\nm <- leaflet(pharm_state) %>% \n  addProviderTiles(providers$CartoDB.DarkMatter) %>% \n  setView(-92.469698, 31.012156, zoom = 7) %>% \n  addCircleMarkers(~lon, ~lat, \n             popup=paste0(pharm_state$BUYER_NAME, \"<br />\",\n                          pharm_state$per_person, \" pills per person per year\"),\n             weight = 3,\n             radius=sqrt(pharm_state$per_person)*3, \n             color=\"#ffa500\", \n             stroke = FALSE, \n             fillOpacity = 0.3) \nm\n```\n\nWhy stop there?\n\nLet's make some style changes based on the data we have.\n\nLike, we can visualize the `BUYER_BUS_ACT` with colors.\n\n\n```{r dunk_map2, fig.width=8, fig.height=4, warning=F, message=F}\n\ncof <- colorFactor(c(\"#ffa500\", \"#13ED3F\"), domain=c(\"CHAIN PHARMACY\", \"RETAIL PHARMACY\"))\n# mapping based on type\nm <- leaflet(pharm_state) %>% \n  addProviderTiles(providers$CartoDB.DarkMatter) %>% \n  setView(-92.469698, 31.012156, zoom = 7) %>% \n  addCircleMarkers(~lon, ~lat,\n             popup=paste0(pharm_state$BUYER_NAME, \"<br />\",\n                          pharm_state$per_person, \" pills per person per year\"),\n             weight = 3,\n             radius=sqrt(pharm_state$per_person)*3, \n             stroke = FALSE, \n             fillOpacity = 0.3,\n             # this line below is really the only thing that's different\n             color=~cof(BUYER_BUS_ACT)) \nm\n```\n\n\nPlay around with the slippy map. Interesting, right?\n\nStill, that's a lot of points to process. I don't recommend more. Unless you switch to a method that won't slow your browser down, which we'lll get into soon.\n\n## Add a legend\n\nLet's add a legend with the function `addLegend()` and options for where to place it and colors and labels.\n\n```{r add_legend, fig.width=8, fig.height=4, warning=F, message=F}\nm <- leaflet(pharm_state)  %>% \n  addProviderTiles(providers$CartoDB.DarkMatter) %>% \n    setView(-92.469698, 31.012156, zoom = 7) %>% \n  addCircleMarkers(~lon, ~lat,\n             popup=paste0(pharm_state$BUYER_NAME, \"<br />\",\n                          pharm_state$per_person, \" pills per person per year\"),\n             weight = 3,\n             radius=sqrt(pharm_state$per_person)*3, \n             stroke = FALSE, \n             fillOpacity = 0.3,\n             color=~cof(BUYER_BUS_ACT))   %>%\n             # this line below is really the only thing that's different\n             addLegend(\"bottomright\", \n                       colors= c(\"#ffa500\", \"#13ED3F\"), \n                       labels=c(\"Chain\", \"Retail\"), \n                       title=\"Pharmacy type\") \n\nm\n```\n\n## Add a more specific legend\n\nLet's add circles to the legend.\n\nWe want to add some customization to the legend to reflect the radius size on the map. This isn't among the default functions in the rleaflet package, but it's doable if you know how the underlying code works both in leaflet and rleaflet.\n\n\n\n```{r circle_legend, fig.width=8, fig.height=5}\n# set legend features\n        colors <- c(\"gray\", \"gray\", \"gray\", \"#ffa500\", \"#13ED3F\")\n        labels <- c(\"5 pills\", \"15 pills\", \"30 pills\", \"Chain\", \"Retail\")\n        sizes <- c(sqrt(5)*3, sqrt(15)*3, sqrt(30)*3, 15, 15)\n        shapes <- c(\"circle\", \"circle\", \"circle\", \"square\", \"square\")\n        borders <- c(\"gray\", \"gray\", \"gray\", \"#ffa500\", \"#13ED3F\")\n\naddLegendCustom <- function(map, colors, labels, sizes, shapes, borders, opacity = 0.5){\n\n            make_shapes <- function(colors, sizes, borders, shapes) {\n                shapes <- gsub(\"circle\", \"50%\", shapes)\n                shapes <- gsub(\"square\", \"0%\", shapes)\n                paste0(colors, \"; width:\", sizes, \"px; height:\", sizes, \"px; border:3px solid \", borders, \"; border-radius:\", shapes)\n            }\n            make_labels <- function(sizes, labels) {\n                paste0(\"<div style='float: right; display: inline-block;height: \", \n                       sizes, \"px;margin-top: 4px;line-height: \", \n                       sizes, \"px;'>\", labels, \"</div>\")\n            }\n            legend_colors <- make_shapes(colors, sizes, borders, shapes)\n            legend_labels <- make_labels(sizes, labels)\n\n            return(addLegend(map, colors = legend_colors, labels = legend_labels, opacity = opacity))\n        }\n\n## okay, back to our map code but replacing the addLegend() function\n## with our new addCustomLegend() function\n        \nm <- leaflet(pharm_state)  %>% \n  addProviderTiles(providers$CartoDB.DarkMatter) %>% \n    setView(-92.469698, 31.012156, zoom = 7) %>% \n  addCircleMarkers(~lon, ~lat,\n             popup=paste0(pharm_state$BUYER_NAME, \"<br />\",\n                          pharm_state$per_person, \" pills per person per year\"),\n             weight = 3,\n             radius=sqrt(pharm_state$per_person)*3, \n             stroke = FALSE, \n             fillOpacity = 0.3,\n             color=~cof(BUYER_BUS_ACT))   %>%\n             # this line below is really the only thing that's different\n             addLegendCustom(colors, labels, sizes, shapes, borders)\n\nm\n```\n## But what about all those other dots...\n\nOkay, fine, I know you're tempted.\n\nWhat if you visualized all of those dots without filtering first?\n\nWell, it'd crash RStudio and probably your browser.\n\nSo let me show you how to do it if you really want to.\n\nWe have to use a WebGL plugin to render those dots well.\n\n```{r leafgl, fig.width=8, fig.height=4, warning=F, message=F}\n# leafgl is not yet on CRAN\n# so uncomment and run the instlal line below\n\n#devtools::install_github(\"r-spatial/leafgl\")\n\nlibrary(leafgl)\nlibrary(sf)\n\n# Convert the latitude and longitude into a geometry for easy mapping\npharms_spatial <- pharmacies %>% \n  st_as_sf(coords=c(\"lon\", \"lat\"), crs = \"+proj=longlat\") \n\nm <- leaflet() %>%\n    addProviderTiles(provider = providers$CartoDB.DarkMatter) %>%\n    addGlPoints(data = pharms_spatial,\n                opacity=.5,\n                popup=\"BUYER_NAME\",\n                group = \"BUYER_BUS_ACT\") %>%\n    setView(-92.469698, 31.012156, zoom = 3) %>% \n    addLayersControl(overlayGroups = \"BUYER_BUS_ACT\")\n\nm\n```\n\nThe downside?\n\nThis new package can’t render circles of varying size yet.\n\nSo this is great for dot density maps, polygons, and lines but little else. \n\nFor now.\n\n-----\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"leaflet-basics.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.251","theme":"cosmo","title":"leaflet basics","editor":"visual"},"extensions":{"book":{"multiFile":true}}}}}