{"title":"mapbox choropleth","markdown":{"yaml":{"title":"mapbox choropleth","format":"html","editor":"visual"},"headingText":"There is no need to run these install lines below if you already have done so","containsRefs":false,"markdown":"\n\n\nAlright, let's make some chropleths with mapdeck (mapbox+webgl).\n\nWe made a quick one in the previous dot density walkthrough, but let's do it again with a few more styling options this time. We'll work with the arcos opioid data so it's similar to the leaflet-choropleths walkthrough.\n\nThe repo containing the data and scripts for this section is on Github. \nTo follow along, simply run the lines of code below in R.\n\n-----\n\n```{r eval=F}\ninstall.packages(\"usethis\")\nusethis::use_course(\"https://github.com/andrewbtran/NICAR-2020-mapping/archive/master.zip\")\n\n# This section is in scripts/06_mapbox_choropleths.R\nfile.edit(\"scripts/06_mapbox_choropleths.R\")\n\n```\n\n\n```{r loading_packages, warning=F, message=F}\n# This function checks if you don't have the correct packages installed yet\n# If not, it will install it for you\npackages <- c(\"sf\", \"tidyverse\", \"tigris\",\n              \"arcos\", \"mapdeck\")\nif (length(setdiff(packages, rownames(installed.packages()))) > 0) {\n  install.packages(setdiff(packages, rownames(installed.packages())), repos = \"https://cran.us.r-project.org\")  \n}\nlibrary(sf)\nlibrary(tidyverse)\nlibrary(tigris)\nlibrary(arcos)\n```\n\n```{r choropleth1, warning=F, message=F, quietly=T, echo=T, results='hide'}\ncounties <- st_read(\"shapefiles/us_counties.shp\")\n```\n\nLet's load the mapdeck library and put in the [Mapbox API key](https://account.mapbox.com/access-tokens/).\n\n```{r mapdeck1}\nlibrary(mapdeck)\n\nmb_key <- \"PutYourKeyHere\"\n```\n\n```{r mbkey, echo=F}\nsource(\"key.R\")\n```\n\n```{r viz_states, fig.width=8, fig.height=4, eval=F}\nmapdeck(token = mb_key, \n        style = mapdeck_style(\"light\"),\n        zoom=10) %>%\n  add_polygon(\n    data =counties,\n    fill_opacity=0.1,\n    stroke_colour=\"black\",\n    stroke_width=1\n  )\n```\n\nAlright, let's bring in some data to join with the county shapes.\n\n```{r data_import, warning=F, message=F}\n#### Import data we want to map ----------------\nannual_summary <- read_csv(\"data/county_pill_summary.csv\")\n```\n\nJoin the data.\n\nIn the leaflet walkthrough we used the `geo_join()` function from the **tigris** package, but the *counties* and *annual_summary* objects are both dataframes, so a simple `left_join()` from **dplyr** will do just fine.\n\n```{r joined}\ncounties_merged_annual <- left_join(counties, annual_summary, by=c(\"GEOID\"=\"countyfips\"))\n\ncounties_merged_annual <- counties_merged_annual %>% \n  filter(!is.na(avg_pills_per_person))\n\n# Setting up the popup text\npopup_sb <- paste0(counties_merged_annual$BUYER_COUNTY, \", \", counties_merged_annual$BUYER_STATE, \"</br/> Average pills per person: \\n\", as.character(counties_merged_annual$avg_pills_per_person))\n```\n\nCheck out the options that we can use with [`add_polygon()`](https://symbolixau.github.io/mapdeck/reference/add_polygon.html).\n\n```{r starbucks_map, fig.width=8, fig.height=5, warning=F, message=F}\n\ncounties_merged_annual$popup <- paste0(\"<strong>\",counties_merged_annual$BUYER_COUNTY, \"</strong><br />\", counties_merged_annual$avg_pills_per_person, \" pills per person per year\")\n```\n\n```{r map_img, eval=F}\nmapdeck(token = mb_key, \n        style = mapdeck_style(\"light\"),\n        zoom=2,\n        location=c(-98.294108,39.628777))%>% \n    add_polygon(\n    data = counties_merged_annual,\n    fill_colour = \"avg_pills_per_person\",\n    fill_opacity = .9,\n    auto_highlight = TRUE,\n    palette = \"inferno\",\n    tooltip = \"popup\",\n    update_view = FALSE\n  )\n```\n\n![](images/choro1.png)\n\n## Let's get crazy\n\nAdd some elevation data.\n\n```{r elevation, fig.width=8, fig.height=5, warning=F, message=F}\n# We'll need to boost the numbers a bit so the elevation can be seen zoomed out\ncounties_merged_annual$elevation <- counties_merged_annual$avg_pills_per_person^2.4\n\nmapdeck(token = mb_key, \n        style = mapdeck_style(\"light\"),\n        zoom=2,\n        location=c(-98.294108,39.628777),\n        pitch = 45 \n        )%>% \n    add_polygon(\n      data = counties_merged_annual,\n      fill_colour = \"avg_pills_per_person\",\n      fill_opacity = .9,\n      auto_highlight = TRUE,\n      palette = \"inferno\",\n      tooltip = \"popup\",\n      update_view = FALSE,\n      elevation = \"elevation\"\n    )\n```\n\n## Fancy heat map\n\nLet's bring in pharmacy locations in Louisiana.\n\n```{r acs}\nla_pharmacies <- read_csv(\"data/la_pharmacies.csv\")\n\nglimpse(la_pharmacies)\n```\n\nThe key thing here is that this dataset represents the locations of around 1,600 pharmacies.\n\nLet's see what that looks like really quick.\n\n```{r scatter1, fig.width=8, fig.height=5, warning=F, message=F, eval=F}\nmapdeck(token = mb_key, style = mapdeck_style(\"light\"),\n        zoom=6,\n        location=c(-92.485530,31.335469)) %>% \n  add_scatterplot(\n    data=la_pharmacies,\n    radius=10,\n    fill_opacity=.3,\n    update_view= FALSE\n  )\n```\n\n![](images/dots1.png)\n\nWe could map out each dot like we have before, but let's say we wanted to do something like a heatmap. But different.\n\nLet's do a hexagon grid-based heatmap.\n\nAnd we'll add a legend as an option.\n\n```{r hexgrid, fig.width=8, fig.height=5, warning=F, message=F, eval=F}\n\nmapdeck(token = mb_key, style = mapdeck_style(\"light\"),\n        zoom=7,\n        location=c(-92.485530,31.335469)) %>% \n  add_hexagon(\n    data=la_pharmacies,\n    radius=4000,\n    update_view= FALSE,\n    legend = TRUE,\n    legend_options=list(title=\"Pharmacies\"),\n    #elevation_scale = 100,\n    colour_range = colourvalues::colour_values(6:1, palette = colourvalues::get_palette(\"viridis\")[70:256,])\n  )\n```\n![](images/hexagons.png)\n\nNow instead of clusters, we get color-shaded hex grids that indicate a high amount of pharmacies in a specific area.\n\nThere's one more version of this in mapbox/mapdeck, square grids.\n\n\n```{r squaregrid, fig.width=8, fig.height=5, warning=F, message=F}\nmapdeck(token = mb_key, style = mapdeck_style(\"light\"),\n        zoom=7,\n        location=c(-92.485530,31.335469)) %>% \n  add_screengrid(\n    data=la_pharmacies,\n    \n    update_view= FALSE,\n    cell_size = 10,\n    opacity=.5,\n    colour_range = colourvalues::colour_values(6:1, palette = colourvalues::get_palette(\"viridis\")[70:256,])\n  )\n```\n\nIt's also quite easy to add a layer of text labels on top of your other layers.\n\n```{r map_labels, fig.width=8, fig.height=5, warning=F, message=F, eval=F}\nlocation <- data.frame(\n  txt=\"NICAR 2020\",\n  lon=-90.067511,\n  lat=29.952622\n)\n\nmapdeck(token = mb_key, style = mapdeck_style(\"light\"),\n        zoom=12,\n        location=c(-90.067511, 29.952622)) %>% \n  add_screengrid(\n    data=la_pharmacies,\n    cell_size = 10,\n    opacity=.5,\n    colour_range = colourvalues::colour_values(6:1, \n    palette = colourvalues::get_palette(\"viridis\")[70:256,])\n    ) %>% \n  add_text(\n    data=location,\n    lon = 'lon',\n    lat = 'lat',\n    fill_colour = 'red',\n    text = 'txt',\n    size = 16,\n    update_view= FALSE\n\n  )\n\n```\n\n![](images/nicarlabel.png)\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"mapbox-choropleth.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.251","theme":"cosmo","title":"mapbox choropleth","editor":"visual"},"extensions":{"book":{"multiFile":true}}}}}