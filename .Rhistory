kable()
#| warning: false
#| message: false
library(tidyverse)
library(knitr)
library(janitor)
devtools::install_github('wpinvestigative/arcos')
library(arcos)
states <- combined_buyer_annual(key="WaPo") %>%
clean_names()
states %>%
head() %>%
kable()
#| warning: false
#| message: false
state_names <- c(state.name, "District of Columbia")
state_abbr <- c(state.abb, "DC")
state_names <- data.frame(state=state_names, buyer_state=state_abbr)
annual_states <- states %>%
group_by(buyer_state, year) %>%
summarize(pills=sum(dosage_unit)) %>%
left_join(state_names) %>%
filter(!is.na(state))
annual_states %>%
head() %>%
kable()
#| warning: false
#| message: false
state_cdc <- read_tsv("data/od_deaths_state.csv") %>%
filter(is.na(Notes)) %>%
clean_names()
state_cdc %>%
head() %>%
kable()
state_joined <- state_cdc %>%
left_join(annual_states) %>%
select(-notes, -state_code, -year_code)
state_joined %>%
head() %>%
kable()
state_joined <- state_joined %>%
mutate(pills_per_person=round(pills/population,1)) %>%
mutate(death_per_1m=round(deaths/population*1000000,1)) %>%
# rename(death_rate=crude_rate) %>%
pivot_longer(cols=c("death_per_1m", "pills_per_person"),
names_to="type",
values_to="rate")
pharm_c <- summarized_county_annual(key="WaPo") %>%
clean_names()
pharm_c %>%
head() %>%
kable()
#| warning: false
#| message: false
county_cdc <- read_tsv("data/od_deaths_county.csv") %>%
filter(is.na(Notes)) %>%
clean_names()
county_cdc %>%
head() %>%
kable()
#| warning: false
#| message: false
library(tidyverse)
library(knitr)
library(janitor)
devtools::install_github('wpinvestigative/arcos')
library(arcos)
states <- combined_buyer_annual(key="WaPo") %>%
clean_names()
states %>%
head() %>%
kable()
#| warning: false
#| message: false
state_names <- c(state.name, "District of Columbia")
state_abbr <- c(state.abb, "DC")
state_names <- data.frame(state=state_names, buyer_state=state_abbr)
annual_states <- states %>%
group_by(buyer_state, year) %>%
summarize(pills=sum(dosage_unit)) %>%
left_join(state_names) %>%
filter(!is.na(state))
annual_states %>%
head() %>%
kable()
#| warning: false
#| message: false
state_cdc <- read_tsv("data/od_deaths_state.csv") %>%
filter(is.na(Notes)) %>%
clean_names()
state_cdc %>%
head() %>%
kable()
state_joined <- state_cdc %>%
left_join(annual_states) %>%
select(-notes, -state_code, -year_code)
state_joined %>%
head() %>%
kable()
state_joined <- state_joined %>%
mutate(pills_per_person=round(pills/population,1)) %>%
mutate(death_per_1m=round(deaths/population*1000000,1)) %>%
# rename(death_rate=crude_rate) %>%
pivot_longer(cols=c("death_per_1m", "pills_per_person"),
names_to="type",
values_to="rate")
pharm_c <- summarized_county_annual(key="WaPo") %>%
clean_names()
pharm_c %>%
head() %>%
kable()
#| warning: false
#| message: false
county_cdc <- read_tsv("data/od_deaths_county.csv") %>%
filter(is.na(Notes)) %>%
clean_names() %>%
rename(geoid=county_code)
county_cdc %>%
head() %>%
kable()
county_joined <- county_cdc %>%
left_join(pharm)
county_joined <- county_cdc %>%
left_join(pharm_c)
county_joined %>%
head() %>%
kable()
#| warning: false
#| message: false
county_cdc <- read_tsv("data/od_deaths_county.csv") %>%
filter(is.na(Notes)) %>%
clean_names() %>%
rename(countyfips=county_code)
county_cdc %>%
head() %>%
kable()
county_joined <- county_cdc %>%
left_join(pharm_c)
county_joined %>%
head() %>%
kable()
county_joined <- county_cdc %>%
left_join(pharm_c) %>%
select(-notes, -state_code, -year_code, -age_adjusted)
county_joined <- county_cdc %>%
left_join(pharm_c) %>%
select(-notes, -state_code, -year_code)
county_joined %>%
head() %>%
kable()
county_joined <- county_cdc %>%
left_join(pharm_c) %>%
select(-notes, -state_code, -year_code, -age_adjusted_rate)
county_joined %>%
head() %>%
kable()
county_joined <- county_joined %>%
mutate(pills_per_person=round(dosage_unit/population,1)) %>%
mutate(death_per_1m=round(deaths/population*1000000,1)) %>%
# rename(death_rate=crude_rate) %>%
pivot_longer(cols=c("death_per_1m", "pills_per_person"),
names_to="type",
values_to="rate")
View(county_joined)
#| warning: false
#| message: false
library(tidyverse)
library(knitr)
library(janitor)
devtools::install_github('wpinvestigative/arcos')
library(arcos)
states <- combined_buyer_annual(key="WaPo") %>%
clean_names()
states %>%
head() %>%
kable()
#| warning: false
#| message: false
state_names <- c(state.name, "District of Columbia")
state_abbr <- c(state.abb, "DC")
state_names <- data.frame(state=state_names, buyer_state=state_abbr)
annual_states <- states %>%
group_by(buyer_state, year) %>%
summarize(pills=sum(dosage_unit)) %>%
left_join(state_names) %>%
filter(!is.na(state))
annual_states %>%
head() %>%
kable()
#| warning: false
#| message: false
state_cdc <- read_tsv("data/od_deaths_state.csv") %>%
filter(is.na(Notes)) %>%
clean_names()
state_cdc %>%
head() %>%
kable()
state_joined <- state_cdc %>%
left_join(annual_states) %>%
select(-notes, -state_code, -year_code)
state_joined %>%
head() %>%
kable()
state_joined <- state_joined %>%
mutate(pills_per_person=round(pills/population,1)) %>%
mutate(death_per_1m=round(deaths/population*1000000,1)) %>%
# rename(death_rate=crude_rate) %>%
pivot_longer(cols=c("death_per_1m", "pills_per_person"),
names_to="type",
values_to="rate")
write_csv(state_joined, "data/opioids_counties.csv", na="")
pharm_c <- summarized_county_annual(key="WaPo") %>%
clean_names()
pharm_c %>%
head() %>%
kable()
#| warning: false
#| message: false
county_cdc <- read_tsv("data/od_deaths_county.csv") %>%
filter(is.na(Notes)) %>%
clean_names() %>%
rename(countyfips=county_code)
county_cdc %>%
head() %>%
kable()
county_joined <- county_cdc %>%
left_join(pharm_c) %>%
select(-notes, -state_code, -year_code, -age_adjusted_rate)
county_joined %>%
head() %>%
kable()
county_joined <- county_joined %>%
mutate(pills_per_person=round(dosage_unit/population,1)) %>%
mutate(death_per_100km=round(deaths/population*100000,1)) %>%
# rename(death_rate=crude_rate) %>%
pivot_longer(cols=c("death_per_100k", "pills_per_person"),
names_to="type",
values_to="rate")
library(tidyverse)
library(geofacet)
state_df <- read_csv("data/opioids_states.csv")
glimpse(state_df)
state_df %>%
filter(state="Tennessee") %>%
ggplot(aes(x=year, y=rate)) +
geom_line() +
theme_minimal()
state_df %>%
filter(state=="Tennessee") %>%
ggplot(aes(x=year, y=rate)) +
geom_line() +
theme_minimal()
state_df %>%
filter(state=="Tennessee") %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
theme_minimal()
state_df %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_wrap(vars(state), ncol=8) +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
#| fig.width=9
#| fig.height=12
state_df %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_wrap(vars(state), ncol=8) +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
#| fig.width=9
#| fig.height=12
state_df %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_wrap(vars(buyer_state), ncol=8) +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
#| fig.width=9
#| fig.height=12
state_df %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_geo(vars(buyer_state)) +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
?facet_geo
county_df <- read_csv("data/opioids_county.csv")
county_df <- read_csv("data/opioids_counties.csv")
glimpse(county_df)
tennessee <- county_df %>%
filter(state=="Tennessee")
glimpes(tennessee)
#| fig.width: 9
#| fig.height: 6
tennessee %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_geo(vars(countyfips), grid = "us_tn_counties_grid1") +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
#| fig.width: 9
#| fig.height: 6
tennessee %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_geo(vars(buyer_county), grid = "us_tn_counties_grid1") +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
#| fig.width: 9
#| fig.height: 6
tennessee %>%
mutate(buyer_county=str_to_title(buyer_county)) %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_geo(vars(buyer_county), grid = "us_tn_counties_grid1") +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
test <- tennessee %>%
mutate(buyer_county=str_to_title(buyer_county))
View(test)
library(tidyverse)
library(geofacet)
state_df <- read_csv("data/opioids_states.csv")
glimpse(state_df)
state_df %>%
filter(state=="Tennessee") %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
#| fig.width: 9
#| fig.height: 10
state_df %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_wrap(vars(buyer_state), ncol=8) +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
#| fig.width: 9
#| fig.height: 6
state_df %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_geo(vars(buyer_state)) +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
#| fig.width: 9
#| fig.height: 6
state_df %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_geo(vars(buyer_state), grid = "us_state_grid2") +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in the U.S.")
county_df <- read_csv("data/opioids_counties.csv")
glimpse(county_df)
tennessee <- county_df %>%
filter(state=="Tennessee")
glimpse(tennessee)
#| fig.width: 9
#| fig.height: 6
tennessee %>%
mutate(buyer_county=str_to_title(buyer_county)) %>%
ggplot(aes(x=year, y=rate, color=type)) +
geom_line() +
facet_geo(vars(buyer_county), grid = "us_tn_counties_grid1") +
theme_minimal() +
labs(title="Rates of opioid purchases and deaths in Tennessee")
View(pharm_c)
glimpse(pharm_c)
glimpse(county_cdc)
tn1 <- filter(county_cdc, state=="Tennessee")
tn2 <- filter(pharm_c, buyer_state=="Tennessee")
tn2 <- filter(pharm_c, buyer_state=="TN")
View(tn1)
View(tn2)
tn3 <- tn2 %>% left_join(tn1)
View(tn3)
tn3 <- tn3  %>%
mutate(pills_per_person=round(dosage_unit/population,1)) %>%
mutate(death_per_100k=round(deaths/population*100000,1)) %>%
# rename(death_rate=crude_rate) %>%
pivot_longer(cols=c("death_per_100k", "pills_per_person"),
names_to="type",
values_to="rate")
View(tn3)
tn3 <- tn2 %>% left_join(tn1)
tn3 <- tn3  %>%
mutate(pills_per_person=round(dosage_unit/population,1)) %>%
mutate(death_per_100k=round(deaths/population*100000,1))
glimpse(state_df)
state_df_06 <-state_df %>%
filter(year==2006) %>%
pivot_wider(names_from="type", values_from="rate")
glimpse(state_df_06)
ggplot(state_df_06, aes(x=deaths_per_1m, y=pills_per_person)) +
geom_point()
state_df_06 <-state_df %>%
filter(year==2006) %>%
pivot_wider(names_from="type", values_from="rate")
glimpse(state_df_06)
ggplot(state_df_06, aes(x=deaths_per_1m, y=pills_per_person)) +
geom_point()
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point()
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point() +
geom_text(aes(label=buyer_state), size=3) +
theme_minimal()
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point() +
geom_text(aes(label=buyer_state), hjust=3, size=3) +
theme_minimal()
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point() +
geom_text(aes(label=buyer_state), hjust=-1, size=3) +
theme_minimal()
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point() +
geom_text(aes(label=buyer_state), hjust=-.5, size=3) +
theme_minimal()
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point() +
geom_text_repel(aes(label=buyer_state), hjust=-.5, size=3) +
theme_minimal()
library(ggrepel)
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point() +
geom_text_repel(aes(label=buyer_state), hjust=-.5, size=3) +
theme_minimal()
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point() +
geom_text_repel(aes(label=buyer_state), size=3) +
theme_minimal()
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point() +
geom_text_repel(data= . %>%
mutate(label=ifelse(death_per_1m>120,
buyer_state, "")),
aes(label=buyer_state), size=3) +
theme_minimal()
ggplot(state_df_06, aes(x=death_per_1m, y=pills_per_person)) +
geom_point() +
geom_text_repel(data= . %>%
mutate(new_label=ifelse(death_per_1m>120,
buyer_state, "")),
aes(label=new_label), size=3) +
theme_minimal()
View(state_joined)
regions <- read_csv("https://github.com/cphalpert/census-regions/raw/master/us%20census%20bureau%20regions%20and%20divisions.csv")
View(regions)
regions <- read_csv("https://github.com/cphalpert/census-regions/raw/master/us%20census%20bureau%20regions%20and%20divisions.csv") %>%
clean_names()
glimpse(state_joined)
glimpse(regions)
state_joined <- left_join(state_joined, regions)
View(state_joined)
glimpse(county_joined)
df <- read_csv("data/opioids_states.csv")
library(tidyverse)
library(gganimate)
install.packages("gganimate")
library(tidyverse)
library(gganimate)
state_df <- read_csv("data/opioids_states.csv")
state_df_wide <-  state_df %>%
pivot_wider(names_from="type", values_from="rate")
glimpse(state_df_wide)
p <- ggplot(
df,
aes(x=death_per_1m, y=pills_per_person,
size=population, color=division)
) +
geom_point(
alpha = 0.7,
show.legend = FALSE
) +
labs(
x = "Deaths per 1 million residents",
y = "Pills per person"
)
p
p <- ggplot(
state_df_wide,
aes(x=death_per_1m, y=pills_per_person,
size=population, color=division)
) +
geom_point(
alpha = 0.7,
show.legend = FALSE
) +
labs(
x = "Deaths per 1 million residents",
y = "Pills per person"
)
p
anim <- p +
transition_time(year)
anim
anim <- p +
transition_time(year)
anim
packages <- c("tidyverse", "lubridate", "geofacet", "ggrepel",
"png", "gifski", "sf", "tigris")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
install.packages(setdiff(packages, rownames(installed.packages())), repos = "http://cran.us.r-project.org")
}
anim <- p +
transition_time(year)
anim
