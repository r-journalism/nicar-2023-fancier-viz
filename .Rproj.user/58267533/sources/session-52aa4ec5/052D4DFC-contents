---
title: "crosstalk flexdashboard"
format: html
editor: visual
---



Sometimes you need an interactive map that you can host internally for reporting purposes, maybe to show an editor or fellow reporters. 

We're going to build on what we've already learned and use two really new packages: [crosstalk](https://rstudio.github.io/crosstalk/) and [flexdashboard](https://rmarkdown.rstudio.com/flexdashboard/).

## Crosstalk

Crosstalk builds on top of the [htmlwidgets](https://htmlwidgets.org/) package (which has been creating all the stuff you've been putting in iframes from R) by letting different elements "talk" to each other. 

![](images/cross1.png)

This lets you alter one interactive by clicking around in another. Usually for filtering.

This level of control is something that one would have to create in R using Shiny, which would require a server and perhaps Docker knowledge.

But Crosstalk doesn't require Shiny. You can use it alone or use R Markdown to generate a static HTML document you can host anywhere. 

**Some limitations:** At the moment it can only links individual data points and not aggregate or summary views. The next big limitation is that you shouldn't use it for huge data sets because it will be all served in a browser.

## Flexdashboard

[Flexdashboard](https://rmarkdown.rstudio.com/flexdashboard/index.html) is simply a package that helps organize [interactive dashboards](https://rmarkdown.rstudio.com/flexdashboard/examples.html) using [bootstrap](https://getbootstrap.com/).

## The plan

We're going to create a truly interactive map and table to visualize pharmacy-level data in Louisana. The data is from the [arcos api](https://wpinvestigative.github.io/arcos/). Basic packages we'll use include [rleaflet](https://rstudio.github.io/leaflet/) and [DT: DataTables](https://rstudio.github.io/DT/).

I'll be referring to different .Rmd files to work from as well as screenshots of the results. I'll be highlighing code in this walkthrough but the code won't really work in your console. 

You must click the *Knit > Knit to flex_dashboard* button to execute and generate the html file.

![](images/knit.png)

The repo containing the data and scripts for this section is on Github. 
To follow along, simply run the lines of code below in R.

-----

```{r eval=F}
# There is no need to run these install lines below if you already have done so
install.packages("usethis")
usethis::use_course("https://github.com/andrewbtran/NICAR-2020-mapping/archive/master.zip")

# This section is in scripts/07_crosstalk_01.Rmd
# This section is in scripts/07_crosstalk_02.Rmd
# This section is in scripts/07_crosstalk_03.Rmd
# This section is in scripts/07_crosstalk_04.Rmd

file.edit("scripts/07_crosstalk_01.Rmd")
file.edit("scripts/07_crosstalk_02.Rmd")
file.edit("scripts/07_crosstalk_03.Rmd")
file.edit("scripts/07_crosstalk_04.Rmd")
```

----

We're going to build this in R Markdown.

The progression of code will be in `07_crosstalk_01.Rmd` through `07_crosstalk_04.Rmd`.

## The data

We're working with data I've already joined and summarized based on raw arcos data.

If you want to see the code looks like, it's in the script folder called `99_state_pharm_data.R`

This is what the summarized data looks like:

```{r glimpse}
library(tidyverse)

state <- read_csv("data/all_pharmacies_summarized.csv")

glimpse(state)
```

It's every store in the country. It has total pills (oxycodone and hydrocodone) within the time span of our data. And it has `per_person` which adjusts total for population by county. **Most importantly,** each pharmacy has latitude and longitude data so we can use to put these locations on a map.

## Setting up the flex dashboard structure

This section is in `07_crosstalk_01.Rmd`.

The first thing you'll notice at the top of the .Rmd file is the text between the **---** signs. This is the [yaml](https://yaml.org/) part of the file that tells RStudio how to knit the file. Sometimes the output is pdf, sometimes it's html, sometime it's simple markdown.

In this instance, we're exporting this file as a flex dashboard, with a [theme](https://www.datadreaming.org/post/r-markdown-theme-gallery/) of paper (You could come up with [your own theme](https://ijlyttle.github.io/communicate_custom_html_document_format_r_markdown.html) if your organization wants a consistent style). 

```{r yaml, eval=F}
---
title: "Crosstalk 1"
author: "NICAR 2020"
date: "3/5/2020"
output:
  flexdashboard::flex_dashboard:
    theme: paper
    source_code: embed
---
```

Okay, that's basic.

Beneath it are the sections of code that are indicated with a **````{r`**.

![](images/chunk1.png)

Anything within this chunk will be treating like a specific code. 

The "r" in **````{r`** indicates that R code will be executed.

If you put in **````{python`** then Python code would be executed in the R markdown.

Anything outside of these **```** will be treated like regular markdown.

Take the time to learn more ways to customize [**your R Markdown code**](https://rmarkdown.rstudio.com/lesson-1.html).

The important thing to understand is this next set of code that sets up the modules you want to show with flex dashboard. Check out [their documentation](https://rmarkdown.rstudio.com/flexdashboard/using.html#layout).

```
Opioids in State {data-icon="ion-stats-bars"}
=====================================  

Column {data-width=200}
-------------------------------------

### Filters
```

This is specific markdown code that flex dashboard recognizes.

It takes data from the yaml section and the text in the code above and sets the header, the column width and what to name that particular section.

We're only going to print text in each R code chunk to see where things end up.

Click *Knit > Knit to flex_dashboard* on the `07_crosstalk_01.Rmd` file.

![](images/flexdash1.png)

Pretty nice, right?

Even nicer considering how we typed zero HTML and CSS.

## Loading and displaying data pt 1

This section is in `07_crosstalk_02.Rmd`.

Alright, let's bring in data and show what it looks like as a filterable table.

We're going to skip the filtering part for now.

We looked at it in our console already but we need to load it into the R markdown file.

Look in the new chunk called `load_and_clean_data`

![](images/chunk2.png)

The important takeaway here is that after loading and filtering the data frame and storing it as `state`, we then used the `SharedData$new()` function to convert `state` into a crosstalk object.

This is like an enhanced data set. You'll see why in a bit.

Look at the `filterable_table` chunk, now.

![](images/chunk3.png)

We've used the `datatable()` function to show the `st` crosstalk dataframe object.

Click *Knit > Knit to flex_dashboard* on the `07_crosstalk_02.Rmd` file.

![](images/flexdash2.png)

## Setting up custom filters

This section is in `07_crosstalk_03.Rmd`.

We're going to alter the `filter_section` code chunk.

![](images/chunk4.png)

We're using a few crosstalk specific filter functions: `filter_select()`, `filter_checkbox()`, and `filter_slider()` that will let us choose how to filter the **st** shared data object.

We've wrapped a couple of them around an additional function: `bscols()` that will pair up a couple of the narrower filters so it looks pretty.

Click *Knit > Knit to flex_dashboard* on the `07_crosstalk_03.Rmd` file.

![](images/flexdash3.png)

Neat, huh?

When we add filters on the left, either with a pull down menu or with the check box or via the slider bar, the table on the right will automatically update.

## Interactive map

This section is in `07_crosstalk_04.Rmd`.

We're going to alter the `interactive_map` code chunk.

You've gone through the leaflet section before. Now, this is tricky.

We're starting with the **st** crosstalk shared object but the values we're setting for radius (`addCircles()`) and the text that we're using to generate the popup text are based on the original **state** dataframe. 

![](images/chunk5.png)

Also, you might have noticed I added some custom images to the popups depending on the **BUYER_DEA_NO**. These files are specific to Louisiana and show a pharmacy's monthly opioid ordering trend compared to the state average.

Click *Knit > Knit to flex_dashboard* on the `07_crosstalk_04.Rmd` file.

![](images/flexdash4.png)

## Final datatable options

Almost done. Let's go back and add some variables to the `datable()` function so we can add some neat customization to it, such as buttons to export the filtered data and scrolling options.

This section is in `07_crosstalk_05.Rmd`.

We're going to alter the `filterable_table` code chunk.

Here's a preview of what we're changing.

For complete documentation of what's available as DT options, visit [their site](https://rstudio.github.io/DT/).

![](images/chunk6.png)

Click *Knit > Knit to flex_dashboard* on the `07_crosstalk_05.Rmd` file.

![](images/flexdash5.png)

Beautiful, no?
