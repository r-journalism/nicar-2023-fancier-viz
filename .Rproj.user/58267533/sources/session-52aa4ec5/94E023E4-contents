---
title: "bivariate maps"
format: html
editor: visual
---

You can follow along with the `bivariate_map.qmd` file in the **nicar-2023-fancier-viz** project folder that you downloaded in the First steps link.

If you've downloaded the appropriate data files and put them in a data folder, you can just copy and paste all the code in the gray boxes in an R script.

This time, we're going to use a few packages: **biscale**, **cowplot**, **sf**, and **tigris**.

Let's load the libraries, import the state-level data and see the structure of the data we've imported.

```{r}
#| warning: FALSE
#| message: FALSE

library(tidyverse)
library(sf)
library(cowplot)
library(biscale)
library(tigris)

county_df <- read_csv("data/opioids_counties_combined.csv")


county_df_wide <-  county_df %>% 
  pivot_wider(names_from="type", values_from="rate")


glimpse(county_df_wide)
```

This is how The Washington Post visualized the geographical relationship between overdoses and purchases:

![](images/compare.png){fig-align="center"}

That's totally doable in R and ggplot2.

Let's first download the county
```{r}
#| warning: FALSE
#| message: FALSE
#| results: 'hide'
us_counties <- counties(cb = TRUE, resolution = "20m") %>%
     shift_geometry()

glimpse(us_counties)
```

```{r}
#| warning: FALSE
#| message: FALSE

bi_df <- bi_class(county_df_wide, x = death_per_100k, y = pills_per_person, style = "quantile", dim = 3)

glimpse(bi_df)
```


```{r}
#| warning: FALSE
#| message: FALSE

ggplot(us_counties) + 
  geom_sf() +
  theme_void()
```

```{r}
us_counties <- us_counties %>% 
  left_join(bi_df, by=c("GEOID"="countyfips"))
```

```{r}
#| warning: FALSE
#| message: FALSE

map <- ggplot() +
  geom_sf(data = us_counties, mapping = aes(fill = bi_class), 
          # changing the border color to white and the size of the
          # border lines to .1
          # and hiding the legend
          color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "GrPink", dim = 3) +
  labs(
    title = "Deaths & Pills"
  ) +
  bi_theme()

map
```

```{r}
#| warning: FALSE
#| message: FALSE

legend <- bi_legend(pal = "GrPink",
                    dim = 3,
                    xlab = "+ death rate ",
                    ylab = "+ pills rate ",
                    size = 8)

legend
```

```{r}
#| warning: FALSE
#| message: FALSE

finalPlot <- ggdraw() +
  draw_plot(map, 0, 0, 1, 1) +
  draw_plot(legend, 0.82, .2, 0.2, 0.2)

finalPlot
```

```{r}
#| warning: FALSE
#| message: FALSE
#| eval: FALSE

save_plot("test.svg", finalPlot, base_height = NULL, base_width = 12)
```

```{r}
#| warning: FALSE
#| message: FALSE

tn_counties <- us_counties %>% 
  filter(STATE_NAME=="Tennessee")

map <- ggplot() +
  geom_sf(data = tn_counties, mapping = aes(fill = bi_class), 
          # changing the border color to white and the size of the
          # border lines to .1
          # and hiding the legend
          color = "white", size = 0.1, show.legend = FALSE) +
  bi_scale_fill(pal = "GrPink", dim = 3) +
  labs(
    title = "Deaths & Pills in Tenn."
  ) +
  bi_theme()


finalPlot <- ggdraw() +
  draw_plot(map, 0, 0, 1, 1) +
  draw_plot(legend, 0.82, .2, 0.2, 0.2)

finalPlot
```
